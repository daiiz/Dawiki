<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="dawiki-line">
  <template>
    <style>
      @import url(https://fonts.googleapis.com/earlyaccess/notosansjapanese.css);
      :host {
        font-family: 'Noto Sans Japanese', sans-serif;
        display: block;
      }

      #line, #editor {
        color: #555;
        font-size: 15px;
        line-height: 25px;
        padding-left: 4px;
        display: block;
      }

      #editor {
        font-family: 'Noto Sans Japanese', sans-serif;
        display: none;
        color: #999 !important;
        width: 100%;
        border: 0;
        box-sizing: border-box;
        padding: 0;
        margin-left: 4px;
        resize: none;
      }

      .title {
        font-size: 28px !important;
        line-height: 38px !important;
        margin-bottom: 6px;
      }

      textarea:focus {
        outline: 0;
        overflow: hidden;
      }
    </style>
    <div id="line" on-click="editable"></div>
    <textarea id="editor" type="text" on-keyup="updateRaw"></textarea>
  </template>

  <script src="../../dist/bundle.js"></script>
  <script>
    class DawikiLine extends Polymer.Element {
      static get is () { return 'dawiki-line' }
      static get properties () {
        return {
          raw    : {
            type: String, 
            value: '',
            observer: '_rawChanged'
          },
          id     : {type: String, value: ''},
          hash   : {type: String, value: ''},
          istitle: {type: Boolean, value: false},
          /* 行の背景色 */
          bgcolor   : {
            type: String, 
            value: '#fff',
            observer: '_bgcolorChanged'
          },
        }
      }

      ready () {
        super.ready();
        this.$.editor.value = this.raw;
        dawiki.initTextarea(this.$.editor);
        if (JSON.parse(this.istitle)) {
          this.$.line.className += ' title';
          dawiki.addClass(this.$.editor, ['title']);
        }
      }

      updateRaw (e) {
        var editor = this.$.editor;
        var keyCode = e.code;
        var txt = editor.value;

        if (keyCode === 'Enter') {
          // 新たな行の追加要求する
          var caretPos = editor.selectionEnd;
          var str = txt.substring(caretPos, txt.length);

          //console.log("foo!", e, editor.selectionEnd, str);
          this.dispatchEvent(new CustomEvent('insertLine', {
            detail: {
              id_after: '',
              body: str,
              caret_position: caretPos
            },
            bubbles: true, 
            composed: true
          }));
        }else {
          this.raw = txt;
        }
      }

      editable (e) {
        this.bgcolor = '#efefef';
        var editor = this.$.editor;
        editor.selectionEnd = 3; // 3文字目の後ろにcaret
        
        var h = this.$.line.offsetHeight;
        dawiki.css(this.$.line, {
          display: 'none'
        });
        dawiki.css(editor, {
          height: h + 'px',
          display: 'block'
        });
        editor.focus();
      }

      _bgcolorChanged (newValue, oldValue) {
        this.$.line.style.backgroundColor = newValue;
      }

      _rawChanged (newValue, oldValue) {
        this._spans(newValue);
      }

      _spans (str) {
        this.$.line.innerHTML = '';
        this.$.line.appendChild(dawiki.spans(str.replace(/\[/g, '').replace(/\]/g, '')));
      }
    }
    window.customElements.define(DawikiLine.is, DawikiLine);
  </script>
</dom-module>
