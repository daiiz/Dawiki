<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="dawiki-line">
  <template>
    <style>
      @import url(https://fonts.googleapis.com/earlyaccess/notosansjapanese.css);
      :host {
        font-family: 'Noto Sans Japanese', sans-serif;
        display: block;
      }

      #line, #editor {
        color: #555;
        font-size: 15px;
        line-height: 25px;
        padding-left: 4px;
        min-height: 25px;
        display: block;
      }

      #editor {
        font-family: 'Noto Sans Japanese', sans-serif;
        display: none;
        color: #999 !important;
        width: 100%;
        border: 0;
        box-sizing: border-box;
        padding: 0;
        margin-left: 4px;
        resize: none;
        caret-color: #555;
      }

      .title {
        font-size: 28px !important;
        line-height: 38px !important;
        margin-bottom: 6px;
      }

      textarea:focus {
        outline: 0;
        overflow: hidden;
      }
    </style>
    <div id="line" on-click="_fireupdateLineHighlight"></div>
    <textarea id="editor" type="text" spellcheck="false" 
      on-keyup="updateRawArrow" on-keypress="updateRawEnter"></textarea>
  </template>

  <script src="../../dist/bundle.js"></script>
  <script>
    class DawikiLine extends Polymer.Element {
      static get is () { return 'dawiki-line' }
      static get properties () {
        return {
          raw: {
            type: String, 
            value: '',
            observer: '_rawChanged'
          },
          id     : {type: String, value: ''},
          hash   : {type: String, value: ''},
          istitle: {type: Boolean, value: false},
          /* 行の背景色 */
          bgcolor   : {
            type: String, 
            value: '#fff',
            observer: '_bgcolorChanged'
          },
        }
      }

      ready () {
        super.ready();
        this.$.editor.value = this.raw;
        dawiki.initTextarea(this.$.editor);
        if (JSON.parse(this.istitle)) {
          this.$.line.className += ' title';
          dawiki.addClass(this.$.editor, ['title']);
        }
      }

      updateRawArrow (e) {
        var editor = this.$.editor;
        var keyCode = e.code;
        var txt = editor.value;
        
        if (keyCode === 'ArrowDown') {
          this.fireupdateLineHighlight(false, true);
          return;
        }

        if (keyCode === 'ArrowUp') {
          this.fireupdateLineHighlight(true, false);
          return;
        }
        this.raw = txt;
      }

      updateRawEnter (e) {
        var editor = this.$.editor;
        var keyCode = e.code;
        var txt = editor.value;

        if (keyCode === 'Enter') {
          // 新たな行の追加要求する
          var caretPos = editor.selectionEnd;
          var tailTxt = txt.substring(caretPos, txt.length);
          var headTxt = txt.substring(0, caretPos);
          this.raw = headTxt;

          this.dispatchEvent(new CustomEvent('insertLine', {
            detail: {
              line_after: this,
              body: tailTxt,
              caret_position: caretPos
            },
            bubbles: true, 
            composed: true
          }));
          return;
        }

        this.raw = txt;
      }

      setEditMode () {
        var editor = this.$.editor;
        editor.selectionEnd = 3; // 3文字目の後ろにcaret
        editor.selectionStart = 3;

        var h = this.$.line.offsetHeight;
        dawiki.css(this.$.line, {
          display: 'none'
        });
        dawiki.css(editor, {
          height: h + 'px',
          display: 'block'
        });
        editor.focus();
        //this._fireupdateLineHighlight();
      }

      setViewMode () {
        this.$.editor.selectionEnd = this.$.editor.value.length;
        dawiki.css(this.$.editor, {
          display: 'none'
        });
        dawiki.css(this.$.line, {
          display: 'block'
        });
      }

      _bgcolorChanged (newValue, oldValue) {
        this.$.line.style.backgroundColor = newValue;
      }

      _rawChanged (newValue, oldValue) {
        var editor = this.$.editor;
        this._spans(newValue);
        if (editor.value !== newValue) {
          editor.value = newValue;
        }
      }

      _spans (str) {
        this.$.line.innerHTML = '';
        this.$.line.appendChild(dawiki.spans(str.replace(/\[/g, '').replace(/\]/g, '')));
      }

      _fireupdateLineHighlight (e) {
        this.fireupdateLineHighlight(false, false);
      }

      fireupdateLineHighlight (prev=false, next=false) {
        var self = this;
        this.dispatchEvent(new CustomEvent('updateLineHighlight', {
          detail: {
            line: self,
            prev: prev,
            next: next
          },
          bubbles: true, 
          composed: true
        }));
      };
    }

    window.customElements.define(DawikiLine.is, DawikiLine);
  </script>
</dom-module>
